name: Notify Insider Flow

on:
  schedule:
    - cron: '0 12 * * *'  # 8:00 AM EDT
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps
        run: pip install requests

      - name: Send Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python -c "
import json, os, requests
from datetime import datetime, timedelta

with open('insider_flow.json') as f:
  data = json.load(f)
top_buys = data['top_buys']
top_sells = data['top_sells']
total_buys = data['total_buys']
total_sells = data['total_sells']

# Calculate the 5-day date range ending today
end_date = datetime.today().replace(hour=0, minute=0, second=0, microsecond=0).strftime('%B %d, %Y')
start_date = (datetime.today() - timedelta(days=4)).replace(hour=0, minute=0, second=0, microsecond=0).strftime('%B %d, %Y')
date_range = f'{start_date}â€“{end_date}'  # e.g., 'June 23â€“June 28, 2025'

# Calculate bias percentages with precise rounding
total_value = float(total_buys + total_sells) if total_buys + total_sells > 0 else 1.0
buy_pct = round((total_buys / total_value * 100), 2) if total_value > 0 else 0.0
sell_pct = round((total_sells / total_value * 100), 2) if total_value > 0 else 0.0
bias_label = 'Neutral Bias' if abs(buy_pct - sell_pct) < 1 else ('Buy-Side Bias' if buy_pct > sell_pct else 'Sell-Side Bias')
bias_detail = f'{bias_label} ({sell_pct}% sell, {buy_pct}% buy) ðŸ‘€'

# Format the message
msg = f'''
ðŸ“Š Insider Flow Summary ({date_range})

ðŸ’° Top Buys: ${top_buys:,.2f}
ðŸ’¥ Top Sells: ${top_sells:,.2f}

ðŸ§® Total Buys: ${total_buys:,.2f} | Total Sells: ${total_sells:,.2f}
ðŸ“‰ {bias_detail}
'''

url = f'https://api.telegram.org/bot{os.getenv('TELEGRAM_BOT_TOKEN')}/sendMessage'
requests.post(url, json={'chat_id': os.getenv('TELEGRAM_CHAT_ID'), 'text': msg})
print('âœ… Telegram sent!')
"